# yaml-language-server: $schema=https://raw.githubusercontent.com/helm-unittest/helm-unittest/main/schema/helm-testsuite.json
suite: virtualservice
templates:
  - virtualservice.yaml
tests:
  - it: should create virtualservice with basic configuration
    set:
      istio:
        enabled: true
        virtualService:
          enabled: true
          hosts:
            - kairoscloud.example.com
          gateways:
            - kairoscloud-gateway
          http:
            - match:
              - uri:
                  prefix: /api
              route:
              - destination:
                  host: kairoscloud-chart
                  port:
                    number: 80
    asserts:
      - isKind:
          of: VirtualService
      - equal:
          path: metadata.name
          value: RELEASE-NAME-kairoscloud-chart
      - equal:
          path: spec.hosts[0]
          value: kairoscloud.example.com
      - equal:
          path: spec.gateways[0]
          value: kairoscloud-gateway
      - equal:
          path: spec.http[0].match[0].uri.prefix
          value: /api

  - it: should create virtualservice with default host when not specified
    set:
      istio:
        enabled: true
        virtualService:
          enabled: true
    asserts:
      - isKind:
          of: VirtualService
      - equal:
          path: spec.hosts[0]
          value: RELEASE-NAME-kairoscloud-chart

  - it: should create virtualservice with annotations
    set:
      istio:
        enabled: true
        virtualService:
          enabled: true
          annotations:
            test-annotation: "test-value"
    asserts:
      - isKind:
          of: VirtualService
      - equal:
          path: metadata.annotations.test-annotation
          value: "test-value"

  - it: should create virtualservice with tcp configuration
    set:
      istio:
        enabled: true
        virtualService:
          enabled: true
          tcp:
            - match:
              - port: 3306
              route:
              - destination:
                  host: mysql
                  port:
                    number: 3306
    asserts:
      - isKind:
          of: VirtualService
      - equal:
          path: spec.tcp[0].match[0].port
          value: 3306
      - equal:
          path: spec.tcp[0].route[0].destination.host
          value: mysql

  - it: should create virtualservice with tls configuration
    set:
      istio:
        enabled: true
        virtualService:
          enabled: true
          tls:
            - match:
              - port: 443
                sniHosts:
                - kairoscloud.example.com
              route:
              - destination:
                  host: kairoscloud-chart
                  port:
                    number: 443
    asserts:
      - isKind:
          of: VirtualService
      - equal:
          path: spec.tls[0].match[0].port
          value: 443
      - equal:
          path: spec.tls[0].match[0].sniHosts[0]
          value: kairoscloud.example.com
