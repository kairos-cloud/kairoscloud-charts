# yaml-language-server: $schema=https://raw.githubusercontent.com/helm-unittest/helm-unittest/main/schema/helm-testsuite.json
suite: hpa
templates:
  - core/hpa.yaml
tests:
  - it: should create hpa with basic configuration
    set:
      autoscaling:
        enabled: true
        minReplicas: 2
        maxReplicas: 10
        targetCPUUtilizationPercentage: 80
    asserts:
      - isKind:
          of: HorizontalPodAutoscaler
      - equal:
          path: metadata.name
          value: RELEASE-NAME-kairoscloud-chart
      - equal:
          path: spec.minReplicas
          value: 2
      - equal:
          path: spec.maxReplicas
          value: 10
      - equal:
          path: spec.scaleTargetRef.kind
          value: Deployment
      - equal:
          path: spec.scaleTargetRef.name
          value: RELEASE-NAME-kairoscloud-chart
      - equal:
          path: spec.metrics[0].resource.target.averageUtilization
          value: 80

  - it: should create hpa for statefulset
    set:
      autoscaling:
        enabled: true
        minReplicas: 1
        maxReplicas: 5
        targetCPUUtilizationPercentage: 70
      statefulset:
        enabled: true
    asserts:
      - isKind:
          of: HorizontalPodAutoscaler
      - equal:
          path: spec.scaleTargetRef.kind
          value: StatefulSet
      - equal:
          path: spec.minReplicas
          value: 1
      - equal:
          path: spec.maxReplicas
          value: 5

  - it: should create hpa with memory metrics only
    set:
      autoscaling:
        enabled: true
        minReplicas: 3
        maxReplicas: 15
        targetMemoryUtilizationPercentage: 85
        targetCPUUtilizationPercentage: null
    asserts:
      - isKind:
          of: HorizontalPodAutoscaler
      - equal:
          path: spec.metrics[0].resource.name
          value: memory
      - equal:
          path: spec.metrics[0].resource.target.averageUtilization
          value: 85

  - it: should create hpa with both cpu and memory metrics
    set:
      autoscaling:
        enabled: true
        minReplicas: 2
        maxReplicas: 20
        targetCPUUtilizationPercentage: 75
        targetMemoryUtilizationPercentage: 90
    asserts:
      - isKind:
          of: HorizontalPodAutoscaler
      - equal:
          path: spec.metrics[0].resource.name
          value: cpu
      - equal:
          path: spec.metrics[0].resource.target.averageUtilization
          value: 75
      - equal:
          path: spec.metrics[1].resource.name
          value: memory
      - equal:
          path: spec.metrics[1].resource.target.averageUtilization
          value: 90

  - it: should not create hpa when disabled
    set:
      autoscaling:
        enabled: false
    asserts:
      - isNull:
          path: metadata

  - it: should create hpa with custom labels
    set:
      autoscaling:
        enabled: true
        minReplicas: 1
        maxReplicas: 5
    asserts:
      - isKind:
          of: HorizontalPodAutoscaler
      - isAPIVersion:
          of: autoscaling/v2
